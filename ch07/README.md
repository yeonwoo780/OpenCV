# Chapter_7

## 	이진 영상처리

#### 영상의 이진화(Binarization)

영상의 이진화는 영상의 픽셀 값을 0 또는 255(1)로 만드는 연산입니다.

0은 검정색, 255는 흰색을 의미합니다.

이진화를 하는 이유는 1. 배경과 객체를 구분, 2. 관심 영역과 비관심 영역 구분 입니다.

마스크 영상도 이진 영상의 한 형태라고 볼 수 있습니다.임계값 함수

1. 그레이스케일 영상의 이진화

   그레이스케일 영상의 이진화는 픽셀 값이 임계값을 넘으면 0(검은색) 임계값 보다 낮으면 255(흰색)으로 표현합니다.

   영상의 히스토그램을 보았을 때 픽셀 값이 100, 150 두 지점에 모여있는 것을 확인할 수 있습니다.

   임계값을 130로 설정한다면 두 지점을 구분할 수 있습니다.

   이처럼 히스토그램을 보고 적절한 임계값을 설정하는 것이 중요합니다.

   <br>

   

- cv2.threshold(src, thresh, maxval, type, dst=None)

  maxval는 255를 입력해 주는 것이 좋습니다.

  이진화를 하고 싶으면 type 인자에 cv2.THRESH_BINARY 나 cv2.THRESH_BINARY_INV를 입력해주면 됩니다.

  <br>



#### 자동 이진화: Otsu방법

임의의 임계값 T에 의해 나눠지는 두 픽셀 부포의 분산이 최소가 되는 T를 선택하는 방법입니다.



Otus 이진화는 그룹 내 분산과 그룹 간 분산을 이용합니다.
$$
\sigma_w^2 = q_1 \sigma_1^2 + q_2 \sigma_2^2
$$


그룹 내 분산을 최소로 하는 곳을 임계값으로 설정합니다.

T가 1~255까지 다 계산하는데 이 계산이 너무 오래 걸리므로 그룹 간 분산을 이용합니다.
$$
\sigma_i^2 = q_1q_2(\mu_1 - \mu_2)^2
$$


모든 t값에 대해 그룹 간 분산을 구하여 최적의 T를 선택합니다

하지만 연산속도가 너무 오래 걸립니다.

Otsu는 Recursion을 이용해 효율적으로 계산하여 연산속도를 높였습니다.

<br>



#### 지역 이진화

균일하지 않은 조명 환경에서 찰영된 영상에서 사용할 수 있습니다.

불균일한 조명이 있는 영상에서는 이진화 결과가 지저분하게 나옵니다.

1. 구역 나눠서 Otsu 이진화 사용하기

   전체 구역을 N등분 하고 각각의 구역에 이진화를 한 뒤에 이어 붙이는 방법

   <br>

   

2. OpenCV 적응형 이진화

   cv2.adaptiveThreshold(src, maxValue, adaptiveMethod, thresholdType, blockSize, C, dst=None)

   - OpenCV에서 제공하는 적응형 이진화 함수

   - 가우시안 블러를 적용하여 노이즈를 제거한 뒤에 Otsu 이진화를 적용

   - 방법 1 보다 더 느립니다.

     <br>

     

#### 모폴로지 (1): 침식과팽창

- 모폴로지 연산

  영상을 형태학적인 측면에서 다루는 기법

  다양한 영상 처리 시스템에서 전처리(pre-processing)  또는 후처리(post-processing) 형태로 널리 사용

  수학적 모폴로지(mathematicalmorphology)

  <br>

  

- 구조 요소(structuring element)

  모폴로지 연산의 결과를 결정하는 커널, 마스크, 윈도우

  모폴로지는 필터링과 비슷한 연산을 내부에서 진행

  모폴로지에서는 필터가 structucturing element임

  다양한 형태가 있지만 주로 정방형 행렬(3X3)

  <br>

  

- 이진 영상의침식(erosion) 연산

  구조 요소가 객체 영역 내부에 완전히 포함될 경우 고정점 픽셀을 255로 설정

  침식 연산은 객체 외각을 깍아내는 연산

  객체 크기는 감소하고 배경은 확대

  <br>

  - 실제 영상의 침식 연산 결과

    객체 영역(흰색)이 점점 줄어듦

    작은 크기의 객체(잡음)제거 효과

    내부 연산은 구조 요소로 전체 영상을 스캔

    구조 요소안에 객체로 가득 찼을 시에 앵커 포인터에 마킹

    전체 영상을 스캔하면서 마킹을 한뒤에 마킹된 부분만 남기고 다 제거

    <br>

    

- 이진 영상의팽창(dilation) 연산

  객체가 커지는 연산

  구조 요소와 객체 영역이 한 픽셀이라도 만날 경우 고정점 픽셀을 255로 설정

  팽창 연산은 객체 외곽을 확대시키는 연산

  객체 크기는 감소되고 배경은 확대

  <br>

  - 실제 영상의 침식 연산 결과

    객체 영역(흰색)이 점점 커집니다.

    객체 내부의 홀(구멍)이 채워지게 됩니다.

    구조 요소 크기와 모양을 어떻게 적용하냐에 따라 다른 형태로 채워나가는 것을 확인할 수 있습니다.



- 모폴로지 침식 연산 함수

  **cv2.erode(src, kernel, dst=None, anchor=None, iterations=None, borderType=None, borderValue=None)**

  kernel에 None을 지정하면 3x3 사각형 구성 요소를 사용

  iteration은 침식 연산을 얼마나 반복할 것인가

  <br>



- 모폴로지 팽창 연산 함수

  cv2.dilate(src, kernel, dst=None, anchor=None, iterations=None, borderType=None, borderValue=None)

  <br>



- 모폴로지 구조 요소(커널) 생성 함수

  cv2.getStructuringElement(shape, ksize, anchor=None)

  <br>

  

#### 모폴로지 (2): 열기와닫기

1. 이진 영상의열기(opening) 연산

   이진 영상에 침식을 적용하고 팽창을 적용하는 기법

   열기 연산을 적용함으로써 작은 돌기, 작은 객체가 사라지고 얇은 연결선이 끊어짐

   열기는 모양이 단순해지긴 하지만 한 두 픽셀 노이즈에 해당하는 객체가 사라지기 때문에 사람들이 많이 사용

   열기 연산은 노이즈를 제거하는 용도로 많이 이용

   <br>

   

2. 이진 영상의닫기(closing) 연산

   닫기 연산은 팽창을 적용하고 침식을 적용하는 기법

   작은 홈, 작은 홀들이 사라지고, 얇은 연결선이 두꺼워 짐

   <br>



3. 범용 모폴로지 연산 함수

   cv2.morphologyEx(src, op, kernel, dst=None, anchor=None, iterations=None,  borderType=None, borderValue=None)



#### 레이블링

-  객체 단위분석

  객체를 분할하여 특징을 분석하는 것을 의미

  영상이 입력되었을 때 객체와 배경이 분리될 수 있다고 가정하며 이진화를 통해 객체와 배경을 분리

  각각의 객체의 모양과 크기를 분석해서 내가 원하는 객체가 어디에 이쓰지 확인하고 싶을 때 객체단위 분석이 필요

  객체 위치 및 크기 정보, ROI 추출, 모양 분석 등을 할 수 있다.

  <br>

  

- **레이블링**

  객체 구역을 영역 단위로 분석하는 것

  서로 연결되어 있는 객체 픽셀에 고유한 번호를 지정하는 작업 (레이블맵)

  이진 영상에서 수행

  레이블링 속도가 외곽선 검출보다 빨라서 더 효율적

  <br>

  

- 외곽선 검출

  각 객체의 외곽선 좌표를 모두 검출

  외곽선 기반 모양 분석

  다양한 외곽선 처리 함수에서 활용 가능 (근사화, 컨벡스헐 등)

  <br>



- 픽셀의 연결관계

  - **4-이웃 연결 관계(4-neighbor connectivity)**

    4-이웃 연결 관계는 어떤 객체가 연결되어 있을 때 두 개 픽셀이 상하좌우 관계로 연결되었을 때를 의미

    <br>

    

  - **8-이웃 연결 관계(8-neighbor connectivity)**

    8-이웃 연결 관계는 상하좌우에 대각선도 포함하여 연결되어 있을 때를 의미

    OpenCV는 보통 8-이웃 연결 관계를 사용

    <br>

- 레이블링 알고리즘의 입력과 출력

   0은 배경 1이상은 객체로 판단

  객체들이 서로 연결되어 있으면 같은 번호를 지정

  같은 객체에 번호가 지정된 것을 레이블 맵

  

- 레이블링 함수

  cv2.connectedComponents(image, labels=None, connectivity=None, ltype=None)

  None값들은 default

  

- 객체 정보를 함께 반환하는 레이블링 함수

  cv2.connectedComponentsWithStats(image, labels=None, stats=None, centroids=None, connectivity=None, ltype=None)
